---
doc_type: "pattern-choice"
status: "draft"
depends:
  contracts:
    - "language-framework-selection"
    - "config-management-tech-selection"
    - "technology-selection-criteria"
    - "error-handling-requirements"
  produces:
    - "logging-tech-selection"
---

# ログ選択

## 概要

Python + FastAPI エコシステムにおけるログライブラリの選択。障害原因特定のための基本的なログ記録を目的とし、一人開発制約下でのシンプルで理解しやすい解決策を決定する。

### 前提

<!-- PREMISE_BEGIN: language-framework-selection -->

Python + FastAPI を採用する。既存スキル活用、技術選択基準「大差ないときは慣れた技術を選ぶ」への適合、疎結合設計による密結合リスク回避により、最適な選択である。

<!-- PREMISE_END: language-framework-selection -->

<!-- PREMISE_BEGIN: config-management-tech-selection -->

設定管理技術として環境変数 + .env ファイル方式を採用する。

<!-- PREMISE_END: config-management-tech-selection -->

<!-- PREMISE_BEGIN: technology-selection-criteria -->

- **最適な技術を選ぶ**: ただし大差ないときは慣れた技術やメジャーなものを選ぶ
- **外部ライブラリは適度に制限**: 依存を少なくして、自分でコントロールできる範囲を広げる
- **監視は最小限**: システムが生きているかどうかを確認する程度の基本的な監視のみ
- **ログは少なめ**: テストでしっかり品質を保つので、ログに頼りすぎない

<!-- PREMISE_END: technology-selection-criteria -->

<!-- PREMISE_BEGIN: error-handling-requirements -->

- **基本ログ記録**: 障害原因特定のための最小限のログ出力
- **通知機能除外**: リアルタイム障害通知は実装しない
- **監視機能任意**: 基本監視は実装可能だが必須ではない

<!-- PREMISE_END: error-handling-requirements -->

## 選択肢と判断基準

ログライブラリとして、「ログは少なめ」の方針を前提とし、障害原因特定のための基本的なログ記録を提供する技術を選択する。

### ログ要件

- **トレースログ**: 非構造化形式で開発時の詳細デバッグに使用
- **運用ログ**: 構造化形式で障害分析・検索に使用
- **出力先制御**: 開発環境と Docker 本番環境での柔軟な出力先切り替え
- **ログレベル制御**: 環境変数による適切なレベル管理

### 環境制約

- **開発環境**: コンソール出力中心、詳細ログでデバッグ支援
- **Docker 本番環境**: 標準出力（stdout/stderr）への出力、構造化ログ
- **設定管理**: 環境変数による出力先・レベル制御

### 判断基準

- シンプルさ (優先度最高) - 一人開発における理解しやすさと設定の簡潔性
- 柔軟性 (優先度高) - 構造化・非構造化ログの両方対応
- 環境対応 (優先度高) - 開発・Docker 環境での統一的な利用
- Python 標準性 - Python エコシステムでの採用実績
- FastAPI 親和性 - FastAPI との統合の自然さ
- 保守負荷 - 外部依存の最小化と長期保守性

### 選択肢

- loguru: 現代的な Python ログライブラリ (シンプル重視)
- structlog: 構造化ログ専門ライブラリ
- Python 標準 logging: 標準ライブラリベース
- rich: 開発時の美しいコンソール出力特化

## 各選択肢の詳細分析

「ログは少なめ」の制約下で、トレース非構造化・運用構造化の要求を満たすログライブラリを評価する。

### loguru

現代的な Python ログライブラリで、シンプルさと柔軟性を両立。

- 利点
  - 極めてシンプルな設定と API
  - 出力先別フォーマット設定が直感的
  - 構造化・非構造化ログ両方に対応
  - 環境変数による動的設定が容易
  - 学習コストが最小限
  - JSON 形式出力 (serialize=True) による構造化ログ
- 欠点
  - Python 標準ライブラリではない外部依存
  - 高度な構造化ログ機能は限定的
  - エコシステムが比較的新しい

実装例:

```python
# トレースログ（非構造化）
logger.add("debug.log", level="TRACE",
           format="{time} | {level} | {function} | {message}")
# 運用ログ（構造化）
logger.add("app.log", level="INFO", serialize=True)
```

### structlog

構造化ログに特化した高機能ライブラリ。

- 利点
  - 構造化ログの設計が最初から組み込まれている
  - 高度なログ処理・変換機能
  - FastAPI エコシステムでの採用実績
  - 豊富なプロセッサーによるログ加工
- 欠点
  - 構造化に特化しており非構造化ログが不得意
  - 設定が複雑で学習コストが高い
  - シンプルさ重視の方針に反する複雑性
  - トレースログ用途には過剰機能

実装考慮:

- 構造化ログには最適だが、非構造化トレースログに不向き
- 複数ライブラリ併用が必要になる可能性

### Python 標準 logging

Python 標準ライブラリのログ機能。

- 利点
  - 外部依存なしで最も軽量
  - 長期的な互換性保証
  - 豊富な学習リソースと採用実績
  - 全ての機能をサポート
- 欠点
  - 設定が複雑で記述量が多い
  - 構造化ログの実装が困難
  - 環境別設定の切り替えが面倒
  - 現代的な開発体験に劣る

実装考慮:

- 基本機能は充実しているが設定の手間が大きい
- JSON 出力には追加ライブラリ（python-json-logger 等）が必要

### rich

開発時の美しいコンソール出力に特化したライブラリ。

- 利点
  - 極めて美しく読みやすいコンソール出力
  - 開発時のデバッグ体験が優秀
  - プログレスバー・テーブル等の豊富な表示機能
- 欠点
  - 開発時のコンソール出力に特化し本番運用に不向き
  - 構造化ログ・ファイル出力機能が限定的
  - Docker 環境での標準出力には不適切
  - ログライブラリとしては機能不足

実装考慮:

- 開発時の補助ツールとしては優秀だが、統一ログ解決策ではない

## 判断基準による評価

### シンプルさの比較

loguru が最もシンプルで直感的である。設定がワンライナーで完結し、一人開発制約下での理解しやすさが際立つ。structlog は構造化ログに優れるが設定が複雑、標準 logging は記述量が多く、rich は用途が限定的である。

### 柔軟性の比較

loguru が構造化・非構造化両方に最も柔軟に対応する。同一ライブラリで出力先別フォーマット設定ができ、トレース非構造化・運用構造化の要求を統一的に満たせる。

### 環境対応の比較

loguru の環境変数による動的設定が最も実用的である。開発時のコンソール詳細出力から Docker 本番での JSON 標準出力まで、設定切り替えで統一的に対応できる。

### Python 標準性の比較

標準 logging が最も標準的だが、実用性とのトレードオフがある。loguru は外部依存だが、Python 界で急速に普及しており、学習リソースも充実している。

### FastAPI 親和性の比較

loguru と structlog がともに FastAPI エコシステムで実績がある。loguru はシンプルさで FastAPI の思想に合致し、structlog は構造化ログで API 監視に適している。

### 保守負荷の比較

loguru が最も保守負荷が軽い。外部依存は 1 つだけで、設定がシンプルで長期的な保守負荷を最小化できる。複雑な設定や多重ライブラリ構成を回避できる。

## 最終選択と根拠

### 選択結果

<!-- GLOBAL_CONCLUSION_BEGIN: logging-tech-selection -->

ログライブラリとして loguru を採用する。

<!-- GLOBAL_CONCLUSION_END: logging-tech-selection -->

### 選択根拠

一人開発制約下でのシンプルさが決定要因である。loguru の直感的な設定により「ログは少なめ」方針を実現しながら、トレース非構造化・運用構造化の両方要求を単一ライブラリで満たせる。環境変数による出力先制御で開発・Docker 本番環境の統一的管理を実現し、「外部ライブラリは適度に制限」方針に適合する最小限の依存で最大限の柔軟性を提供する。「基本ログ記録」要件を満たしながら、設定・保守負荷を最小化し、理解しやすい構造での長期運用を可能にする。

### 実装方針

#### ログ出力戦略

- **トレースログ**: 非構造化形式、開発時デバッグ用
- **運用ログ**: 構造化 JSON 形式、障害分析・検索用
- **出力先制御**: 環境変数による開発・本番環境切り替え
- **レベル管理**: 環境別の適切なログレベル設定

#### 環境別設定

- **開発環境**: コンソール詳細出力、TRACE レベル
- **Docker 本番**: 標準出力 JSON 形式、INFO レベル
- **設定管理**: 環境変数 (LOG_LEVEL, LOG_OUTPUT) による制御
