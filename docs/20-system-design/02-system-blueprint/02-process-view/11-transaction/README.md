---
doc_type: "pattern-logic"
status: "draft"
depends:
  contracts:
    - "request-processing-design"
    - "domain-model"
    - "development-constraints"
  produces:
    - "transaction-design"
---

# トランザクション設計

## 前提

<!-- PREMISE_BEGIN: request-processing-design -->

CogitoWeave のリクエスト処理設計として、**同期処理ベース・トランザクション分離型**アプローチを採用する。

基本的に同期処理でシンプルな処理フローを実現し、複雑な業務処理は 1 トランザクション内で完結させる。エラーハンドリングは開発者対応の緊急度に応じたログレベル（ERROR=即座対応、WARN=計画的改善、INFO=動作確認、DEBUG=開発詳細）を採用し、ユーザーには理解しやすいエラーメッセージのみを提供する。

トランザクション制御はデータベース操作のみを対象とし、外部 API 呼び出しは分離する。リクエストデータのバリデーションは型チェック、範囲チェック、形式チェックを含む定型的な検証を実施し、ビジネスロジックに依存する検証は別レイヤーで処理する。全 API に 10 秒の統一タイムアウトを設定し、外部 API エラー時はフロントエンド側リトライで対応する。N+1 問題対策とクエリ最適化により性能要件を満たす。

<!-- PREMISE_END: request-processing-design -->

<!-- PREMISE_BEGIN: domain-model -->

CogitoWeave のドメインモデルは薄いドメイン層アプローチを採用する。4 つのエンティティ（概念、文献メモ、関係性、文献）に対して基本的な CRUD 操作と最小限のビジネス制約のみを実装し、複雑なドメインロジックはアプリケーション層に委ねる。データベース制約による整合性管理を活用し、外部 API 処理は分離する。

<!-- PREMISE_END: domain-model -->

<!-- PREMISE_BEGIN: development-constraints -->

- シンプルで理解しやすい構造、一人で管理可能な複雑度に制限する。

<!-- PREMISE_END: development-constraints -->

## 論理

第一に、データ整合性とトランザクション境界は個人の知識資産保護において最も重要な設計要素である。概念・文献メモ・関係性は相互に関連する知識体系であり、部分的な更新失敗により不整合状態が生じた場合、知識体系全体の信頼性が損なわれる。1 つの API リクエスト内で関連するデータ更新を完全に成功させるか、失敗時は全てをロールバックする原子性が必須となる。

第二に、分離レベルはパフォーマンスとデッドロック回避を両立する設定が必要である。MySQL の REPEATABLE_READ はギャップロック・ネクストキーロックによりデッドロック発生リスクが高く、リスクを考慮すると採用すべきでない選択肢である。READ_COMMITTED による適度な分離レベルにより、ファントムリード許容とデッドロック回避のバランスを実現し、安定した動作を確保する。

第三に、デッドロック対応は予防と例外処理の二重対策が効果的である。テーブルアクセス順序の統一により根本的なデッドロック発生を抑制し、万一発生した場合は例外処理による適切なエラーレスポンスで対応する。個人開発の制約下では複雑なリトライ機構より、シンプルで理解しやすい対応策が長期保守性を確保する。

## 結論

<!-- GLOBAL_CONCLUSION_BEGIN: transaction-design -->

CogitoWeave のトランザクション設計として、**READ_COMMITTED・順序制御型**アプローチを採用する。

1 つの API リクエスト内で関連するデータ更新を 1 つのトランザクションで完結させ、部分失敗時は全てロールバックする原子性を確保する。外部 API 呼び出しはトランザクション外で処理し、データベース操作のみをトランザクション境界とする。

分離レベルは READ_COMMITTED を採用し、ギャップロック・ネクストキーロックによるデッドロック危険性を回避する。テーブルアクセス順序を統一してデッドロック発生を予防し、万一発生した場合は例外処理でエラーレスポンスを提供する。データベース制約による整合性管理を活用し、シンプルで理解しやすいトランザクション制御を実現する。

<!-- GLOBAL_CONCLUSION_END: transaction-design -->
