---
doc_type: "pattern-logic"
status: "draft"
depends:
  contracts:
    - "service-boundaries-decision"
    - "service-coordination-pattern"
    - "development-constraints"
  produces:
    - "data-consistency-strategy"
---

# データ整合性設計

CogitoWeave システムの 3 サービス完全分離構成における整合性戦略を設計する。単一データストア責務による強い整合性を確立する。

## 前提

<!-- PREMISE_BEGIN: service-boundaries-decision -->

技術的観点からの最適解は**3 サービス完全分離**となる：

- **コア知識管理サービス**: 安定した CRUD 処理を独立プロセスで実行し、長期安定リリースサイクルで運用
- **LLM 統合サービス**: 外部 API 依存を独立プロセスで分離し、技術進歩に応じた中期リリースサイクルで運用
- **コンテンツ取得サービス**: Web スクレイピングを独立プロセスで分離し、サイト変更に応じた短期リリースサイクルで運用

この構成により実行時の責務分離とリリースサイクルの最適化を両立し、各サービスの独立性を確保できる。

<!-- PREMISE_END: service-boundaries-decision -->

<!-- PREMISE_BEGIN: service-coordination-pattern -->

- **フロントエンド直接呼び出し**: フロントエンドから各サービスを直接呼び出す。
- **一方向依存**: フロントエンドからコンテンツ取得サービスと LLM 統合サービスへの依存のみ存在し、サービス間の相互依存は発生しない。
- **タイムアウトつき同期通信**: フロントエンドから各サービスへの通信はタイムアウトつき同期通信で行う。

<!-- PREMISE_END: service-coordination-pattern -->

<!-- PREMISE_BEGIN: development-constraints -->

- シンプルで理解しやすい構造、一人で管理可能な複雑度に制限する。

<!-- PREMISE_END: development-constraints -->

## 論理

### 問題設定

3 つの独立サービス間でデータ整合性を保つ戦略を設計する必要がある。各サービスの責務とデータ操作パターンを分析し、最適な整合性戦略を論理的に導出する。

### 分析

#### サービス別データ責務の整理

各サービスのデータ操作責務を明確化する。

**コア知識管理サービス**は概念管理・文献メモ管理・関係性管理・質問探索の全データを永続化する。CREATE、READ、UPDATE、DELETE の完全な CRUD 操作を担当し、システム唯一のデータストア責務を持つ。

**LLM 統合サービス**は外部 LLM API からの一時的なレスポンス取得のみを担当する。取得したデータは永続化せず、フロントエンドに直接渡すステートレスな操作のみを行う。データストア操作は一切発生しない。

**コンテンツ取得サービス**は外部 Web サイトからの HTML・テキスト取得のみを担当する。取得したコンテンツは永続化せず、フロントエンドに直接渡すステートレスな操作のみを行う。データストア操作は一切発生しない。

#### 整合性要件の分析

責務分析から整合性要件を導出する。

**データストア集約**: コア知識管理サービスのみがデータ永続化を担当するため、データストアは単一である。単一データストア内でのトランザクション制御により強い整合性を実現できる。

**サービス間データ依存**: LLM 統合サービスとコンテンツ取得サービスはデータを永続化しないため、サービス間でのデータ整合性問題は発生しない。各サービスの取得データは一時的であり、他サービスの状態と無関係である。

**サービス間データ依存がないため整合性制御不要**: データ更新はコア知識管理サービス内でのみ発生し、他サービスはデータを永続化しないため、サービス間での整合性制御は不要である。

#### 整合性戦略の決定

分析結果から最適な整合性戦略を論理的に導出する。

**単一責務による強い整合性**: データ永続化責務をコア知識管理サービスに集約し、ACID 特性を持つ単一データストア内でトランザクション制御を行う。これにより分散システムでありながら強い整合性を実現できる。

**ステートレスサービスの分離**: LLM 統合サービスとコンテンツ取得サービスをステートレスに設計し、データ整合性の対象外とする。外部依存による障害時も整合性への影響を排除できる。

**シンプルな制御フロー**: データ更新フローを「外部取得 → フロントエンド統合 → コア保存」の一方向に限定し、複雑な整合性制御を回避する。開発制約のシンプルで理解しやすい構造を満たせる。

## 結論

<!-- GLOBAL_CONCLUSION_BEGIN: data-consistency-strategy -->

- **単一データストア責務**: コア知識管理サービスのみがデータ永続化を担当する。
- **ステートレスサービス分離**: LLM 統合サービスとコンテンツ取得サービスは外部データ取得のみを担当し、データを永続化しない。
- **一方向データフロー**: 「外部取得 → フロントエンド統合 → コア保存」の流れに限定する。

<!-- GLOBAL_CONCLUSION_END: data-consistency-strategy -->

### 論理的根拠

単一データストア責務により、ACID 特性を持つ単一データストア内でトランザクション制御を行い、分散システムでありながら強い整合性を実現できる。

ステートレスサービス分離により、サービス間でのデータ整合性問題は発生せず、分散トランザクション制御は不要となる。

一方向データフローにより、複雑な整合性制御を回避し、開発制約のシンプルで理解しやすい構造を満たせる。
