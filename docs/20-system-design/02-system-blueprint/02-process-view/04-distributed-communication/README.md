---
doc_type: "pattern-logic"
status: "draft"
depends:
  contracts:
    - "service-coordination-pattern"
    - "data-consistency-strategy"
    - "api-tech-approach"
    - "api-contract"
    - "frontend-rendering-style"
  produces:
    - "distributed-communication-design"
---

# 分散通信設計

CogitoWeave システムの 3 サービス完全分離構成における具体的な通信設計を行う。REST API によるシンプルな同期通信を確立する。

## 前提

<!-- PREMISE_BEGIN: service-coordination-pattern -->

CogitoWeave システムのサービス間協調では以下を採用する。

フロントエンドから各サービスを直接呼び出す。フロントエンドからコンテンツ取得サービスと LLM 統合サービスへの依存のみ存在し、サービス間の相互依存は発生しない。

サービス間通信はタイムアウトつき同期通信で行う。開発制約のシンプルで理解しやすい構造を満たし、一人で管理可能な複雑度に制限できる。

<!-- PREMISE_END: service-coordination-pattern -->

<!-- PREMISE_BEGIN: data-consistency-strategy -->

CogitoWeave システムでは以下のデータ整合性戦略を採用する：

**単一データストア責務による強い整合性**を確立する。コア知識管理サービスのみがデータ永続化を担当し、ACID 特性を持つ単一データストア内でトランザクション制御を行う。これにより分散システムでありながら強い整合性を実現する。

**ステートレスサービス分離**により整合性スコープを限定する。LLM 統合サービスとコンテンツ取得サービスは外部データ取得のみを担当し、データを永続化しない。サービス間でのデータ整合性問題は発生せず、分散トランザクション制御は不要である。

**一方向データフロー**でシンプルな制御を実現する。「外部取得 → フロントエンド統合 → コア保存」の流れに限定し、複雑な整合性制御を回避する。開発制約のシンプルで理解しやすい構造を満たす。

<!-- PREMISE_END: data-consistency-strategy -->

<!-- PREMISE_BEGIN: api-tech-approach -->

API 技術方針として REST API を採用する。

<!-- PREMISE_END: api-tech-approach -->

<!-- PREMISE_BEGIN: api-contract -->

CogitoWeave の API 契約は以下の 9 つの論理的 API 群で構成される:

### エンティティ操作 API

1. **概念 API**: 作成・読み取り・更新 (削除は優先度低)
2. **文献メモ API**: 作成・読み取り・更新・概念別一覧取得
3. **関係性 API**: 作成・読み取り・更新 (概念間の重複関係許可)
4. **文献 API**: 作成・読み取り (URL・タイトル・引用が必須)

### 検索・発見 API

1. **概念検索 API**: 名前・説明での部分一致検索
2. **質問から概念候補提示 API**: 既存個人概念体系からの検索・発見支援

### 協働・処理 API

1. **LLM 要約生成 API**: 記事内容と概念 ID から観点別要約を生成
2. **記事取得 API**: URL からタイトル・内容を取得
3. **バックアップ API**: Webhook 化による自動実行支援

これらの API により、概念中心の知識体系構築と効率的な知識活用が実現される。

<!-- PREMISE_END: api-contract -->

<!-- PREMISE_BEGIN: frontend-rendering-style -->

CogitoWeave のフロントエンドレンダリングスタイルとして**CSR(Client-Side Rendering)**を採用する。3 画面間の状態共有効率と軽量なコンポーネント指向の特性を活かし、一人での開発における保守性と理解しやすさを確保する。

<!-- PREMISE_END: frontend-rendering-style -->

## 論理

### 問題設定

3 つの独立サービス間で具体的な通信設計を行う必要がある。REST API によるフロントエンド直接呼び出しパターンを実現し、シンプルで保守しやすい通信設計を論理的に導出する。

### 分析

#### サービス別通信パターンの整理

各サービスの通信特性を分析し、最適な設計パターンを導出する。

**コア知識管理サービス**は 9 つの API 群のうち 7 つ(エンティティ操作 API 4 つ + 検索・発見 API 2 つ + バックアップ API)を提供する。標準的な CRUD 操作が中心で、予測可能な応答時間と高い可用性を要求される。データ永続化を担当するため、トランザクション整合性の維持が必要である。

**LLM 統合サービス**は LLM 要約生成 API と質問から概念候補提示 API を提供する。外部 LLM API への依存により応答時間が変動し、API 制限やレート制限の影響を受ける可能性がある。ステートレスな処理のため、障害時のリトライが容易である。

**コンテンツ取得サービス**は記事取得 API を提供する。Web スクレイピングによりネットワーク状況とサイト構造に依存し、処理時間が大きく変動する。ステートレスな処理のため、障害時のリトライが容易である。

#### 通信プロトコル設計

REST API の具体的実装方針を決定する。

**HTTP/HTTPS 使用**により標準的な Web 通信プロトコルを採用する。ブラウザからの直接アクセスに必要な CORS 対応が標準でサポートされ、デバッグツールやモニタリングツールが豊富に利用できる。

**JSON データフォーマット**により軽量で解析しやすいデータ交換を実現する。JavaScript との親和性が高く、フロントエンドでの処理が簡素化される。スキーマ定義によるデータ検証も可能である。

**HTTP 通信による CQS ベースの API 設計**を行う。GET による参照系操作と POST による更新系操作の明確な分離により、シンプルで理解しやすい API 設計を実現する。

#### エラーハンドリング設計

各サービスの特性に応じたエラー処理戦略を設計する。

**サービス特性ごとのタイムアウト設定**により応答時間制御を行う。各サービスの処理特性に応じた段階的設定で、適切な応答時間管理を実現する。

**HTTP ステータスコード活用**により統一的なエラー分類を行う。4xx 系でクライアントエラー、5xx 系でサーバーエラーを表現し、フロントエンドでの適切なエラー処理を支援する。

**サービス特性ごとのリトライ戦略**によりネットワーク障害への対応を行う。安定なサービスは自動リトライ、外部依存サービスは手動リトライも含めた適切なリトライ方式で、一時的障害を処理する。

#### セキュリティ考慮

個人用システムに適した最小限のセキュリティ設計を行う。

**HTTPS 通信**により通信内容の暗号化を行う。プロトタイプ段階でも基本的な通信セキュリティを確保する。

**CORS 設定**によりブラウザからの適切なアクセス制御を行う。開発環境と本番環境での適切なオリジン制限を設定する。

**認証認可は除外**する。個人用途のプロトタイプとして、高度なユーザー認証機能は実装しない。作成者本人のみのアクセス制御は、デプロイメント環境レベルで対応する。

## 結論

<!-- GLOBAL_CONCLUSION_BEGIN: distributed-communication-design -->

CogitoWeave システムでは以下の分散通信設計を採用する：

**HTTP API による直接通信**を確立する。フロントエンドから 3 サービスへの直接 HTTP/HTTPS 通信により、シンプルで理解しやすい通信アーキテクチャを実現する。JSON データフォーマットと GET/POST による CQS ベースの API 設計で、保守しやすい通信を行う。

**サービス特性ごとのタイムアウト設定**により適切な応答制御を行う。各サービスの処理特性に応じた段階的設定で、適切な応答時間管理を実現する。

**HTTP ステータスコードによるエラーハンドリング**によりシンプルな障害対応を実現する。統一的エラー分類と、サービス特性ごとのリトライ戦略により、外部依存による障害を適切に処理する。

**最小限セキュリティ設計**で個人用途に適した設計を行う。HTTPS 通信と CORS 設定による基本的なセキュリティを確保し、認証認可機能は除外する。作成者本人のみのアクセス制御はデプロイメント環境で対応する。

<!-- GLOBAL_CONCLUSION_END: distributed-communication-design -->
