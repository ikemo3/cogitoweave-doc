---
doc_type: "pattern-logic"
status: "draft"
depends:
  contracts:
    - "monitoring-design"
    - "development-constraints"
    - "testing-automation-requirements"
  produces:
    - "intra-service-test-strategy"
---

# サービス内テスト戦略

CogitoWeave システムにおける統合テストとユニットテストの戦略を策定する。個人開発に適したシンプルで確実なテスト体制を確立する。

## 前提

<!-- PREMISE_BEGIN: monitoring-design -->

CogitoWeave システムでは以下の監視設計を採用する：

**サービス特性別監視戦略**により各サービスに最適化された監視を実現する。コア知識管理サービスはデータ整合性と応答時間を重視し、LLM 統合サービスは外部 API 依存性を監視し、コンテンツ取得サービスは取得成功率と構造変更を追跡する。各サービスの責務に応じた監視により、効率的な障害特定と対応を支援する。

**階層的監視項目設計**により管理負荷と監視効果のバランスを達成する。必須監視項目で基本動作を保証し、性能監視項目で応答時間制約を管理し、運用監視項目で長期的な運用判断を支援する。重要度に応じた監視レベルにより、一人運用での効率的な監視を実現する。

**個人用途最適化アラート**により過剰通知を回避し、重要問題への集中を支援する。緊急度分類による適切な通知と、アラート抑制による根本原因の明確化により、一人での迅速な障害対応を可能にする。シンプルな保守性を維持しながら、システムの安定運用を確保する。

<!-- PREMISE_END: monitoring-design -->

<!-- PREMISE_BEGIN: development-constraints -->

- シンプルで理解しやすい構造、一人で管理可能な複雑度に制限する。

<!-- PREMISE_END: development-constraints -->

<!-- PREMISE_BEGIN: testing-automation-requirements -->

- **バックエンドは完全に自動テスト**: ほぼ 100%のテストで品質を担保する
- **フロントエンドは状況に応じて使い分け**: ブラウザでの複雑な操作やデザインの確認は手動テスト、ロジック部分は自動テストを行う
- **障害対応をスクリプト化**: 復旧作業を自動化して保守の負担を減らす
- **データ移行を自動化**: データベース構造を変更するときは自動で処理する

<!-- PREMISE_END: testing-automation-requirements -->

## 論理

### 問題設定

3 つのサービス（コア知識管理、LLM 統合、コンテンツ取得）それぞれの特性に応じたテスト戦略を策定する必要がある。個人開発の制約下で、外部依存を含むシステムの品質保証を効率的に実現するテスト体制を論理的に導出する。

### 分析

#### サービス別テスト要件の分析

各サービスの特性に応じたテスト要件を分析し、適切なテスト戦略を決定する。

**コア知識管理サービス**: CRUD 操作とデータ整合性が中核であり、データベース操作の正確性と境界条件での動作が最重要である。ユニットテストでビジネスロジックを検証し、統合テストでデータベース操作とトランザクション境界を確認する必要がある。外部依存が最小のため、テスト環境の構築が最も単純である。

**LLM 統合サービス**: 外部 API への依存度が高く、API 仕様の変更や応答時間の変動による影響を受けやすい。外部 API の契約レベルでの検証と、異常ケース（タイムアウト、エラーレスポンス）への対応が必要である。モック化による安定したテスト実行と、契約テストによる仕様変更の早期検知が重要である。

**コンテンツ取得サービス**: Web スクレイピングによりサイト構造の変更に影響されやすく、取得成功率の維持が課題である。HTML 構造の変動に対する適応性と、ネットワーク障害への対応を検証する必要がある。短期リリースサイクルに対応するため、迅速なテスト実行とデプロイメント後の動作確認が重要である。

#### テスト環境戦略の設計

個人開発に適したテスト環境を論理的に設計する。

**軽量テスト環境の採用**: SQLite を使用したインメモリテスト環境により、高速なテスト実行とシンプルな環境管理を実現する。RDBMS 間の差異は最小限であり、個人開発においては実行速度と管理負荷の軽減が優先される。本番環境との完全一致よりも、継続的な品質検証の確実性を重視する。

**外部依存の分離**: 外部 API と Web サイトへの依存を完全にモック化し、テスト実行の安定性を確保する。ネットワークや外部サービスの状態に依存しないテスト環境により、一人開発での継続的インテグレーションを実現する。

#### 外部依存テスト戦略の論理

外部依存を含むシステムの品質保証を効率的に実現する戦略を設計する。

**契約テストによる仕様変更検知**: 外部 API の契約（リクエスト・レスポンス仕様）を明文化し、契約レベルでの自動検証を実装する。API 仕様の変更や破壊的変更を早期に検知し、適応的な修正を支援する。完全なエンドツーエンドテストよりも、変更の影響範囲を限定した効率的な検証を実現する。

**異常ケーステストの体系化**: タイムアウト、エラーレスポンス、ネットワーク障害等の異常ケースを体系的にテストし、外部依存による障害への耐性を確保する。監視設計で定義された障害パターンに対応するテストシナリオを構築し、運用時の障害対応を支援する。

#### CI 統合戦略の設計

個人開発に適した継続的インテグレーション戦略を論理的に導出する。

**シンプル CI 戦略の採用**: プッシュ時の全テスト実行とマージ停止による品質ゲートを基本とし、複雑な段階実行は避ける。一人開発においては設定の理解しやすさと保守負荷の軽減が、柔軟性よりも重要である。確実に動作するシンプルな CI により、継続的な品質保証を実現する。

**失敗時の迅速復旧**: テスト失敗時は修正または revert による迅速復旧を基本とし、複雑な障害分析機構は実装しない。明確なエラーメッセージと再現可能なテスト環境により、個人での効率的な問題解決を支援する。

## 結論

<!-- GLOBAL_CONCLUSION_BEGIN: intra-service-test-strategy -->

CogitoWeave システムでは以下のサービス内テスト戦略を採用する：

**サービス特性別テスト設計**により各サービスに最適化されたテスト体制を構築する。コア知識管理サービスはデータベース操作とトランザクション境界を重点的に検証し、LLM 統合サービスは外部 API の契約テストと異常ケース対応を強化し、コンテンツ取得サービスは構造変更への適応性を継続的に検証する。各サービスの責務に応じたテスト戦略により、効率的な品質保証を実現する。

**軽量テスト環境戦略**により個人開発に適した継続的テストを実現する。SQLite インメモリ環境による高速実行と、外部依存の完全モック化による安定性確保により、一人運用での継続的インテグレーションを支援する。本番環境との完全一致よりも実行速度と管理負荷の軽減を優先し、確実なテスト実行を保証する。

**契約テストによる外部依存管理**により変更への適応性を確保する。外部 API 仕様の明文化と契約レベルでの自動検証により、仕様変更の早期検知と適応的修正を支援する。異常ケーステストの体系化により外部依存障害への耐性を確保し、監視設計と連携した包括的な品質保証体制を構築する。

**シンプル CI 統合**により継続的品質保証を実現する。プッシュ時全テスト実行による品質ゲートと、失敗時の迅速復旧により、個人開発での効率的な品質管理を支援する。理解しやすく保守負荷の軽い CI 構成により、長期的な開発生産性を確保する。

<!-- GLOBAL_CONCLUSION_END: intra-service-test-strategy -->
