---
doc_type: "pattern-logic"
status: "draft"
depends:
  contracts:
    - "security-requirements"
    - "request-processing-design"
    - "development-constraints"
  produces:
    - "security-design"
---

# セキュリティ設計

## 前提

<!-- PREMISE_BEGIN: security-requirements -->

- 必須対応として実装する
  - 外部 API 接続時の HTTPS 通信(LLM API・MCP 統合)
  - SQL インジェクションと XSS に対する基本的な対策の実装
  - 個人情報保護法に基づくプライバシー配慮設計
  - LLM API 利用規約・各種サービス規約の遵守
  - 攻撃対象面の限定(作成者個人環境のみ)によるリスク軽減
- 任意対応として実装する
  - 作成者本人のみがアクセスできる制御を Cloudflare Access で実装
  - 全通信の HTTPS 暗号化
- 実装対象から除外する
  - 高度なユーザー認証機能(プロトタイプ段階)
  - データ暗号化(プロトタイプ段階)
  - 詳細なアクセス制御(プロトタイプ段階)

<!-- PREMISE_END: security-requirements -->

<!-- PREMISE_BEGIN: request-processing-design -->

- **同期処理ベース**: 基本的に同期処理でシンプルな処理フローを実現し、複雑な業務処理は 1 トランザクション内で完結させる。
- **ログレベル設定**: 開発者対応の緊急度に応じたログレベル（ERROR=即座対応、WARN=計画的改善、INFO=動作確認、DEBUG=開発詳細）を採用し、ユーザーには理解しやすいエラーメッセージのみを提供する。
- **トランザクション分離**: データベース操作のみを対象とし、外部 API 呼び出しは分離する。
- **リクエスト検証**: 型チェック、範囲チェック、形式チェックを含む定型的な検証を実施し、ビジネスロジック検証は別レイヤーで処理する。
- **統一タイムアウト**: 全 API に 10 秒の統一タイムアウトを設定し、外部 API エラー時はフロントエンド側リトライで対応する。
- **性能最適化**: N+1 問題対策とクエリ最適化により性能要件を満たす。

<!-- PREMISE_END: request-processing-design -->

<!-- PREMISE_BEGIN: development-constraints -->

- シンプルで理解しやすい構造、一人で管理可能な複雑度に制限する。

<!-- PREMISE_END: development-constraints -->

## 論理

第一に、サービス内セキュリティ設計は個人環境における適切な防御レベルを確立すべきである。攻撃対象面が作成者個人環境に限定されるため、高度な認証機能や複雑なアクセス制御は不要である。一方で、SQL インジェクション・XSS 対策等の基本的なセキュリティ実装は、開発者としての責任とプロフェッショナルな品質確保において必須となる。

第二に、HTTP レベルのセキュリティ対策は最小限の設定で最大限の防御効果を実現すべきである。セキュリティヘッダー設定により、ブラウザレベルでの攻撃防御を自動化し、開発・保守負荷を抑制しながら堅牢性を向上させる。ただし、HSTS 設定は開発・テスト環境での支障を避けるため除外し、実用性と安全性のバランスを確保する。

第三に、既存のリクエスト処理設計との統合により、レイヤー別責務分離を実現すべきである。リクエストバリデーションでの入力検証、データベース操作での SQL インジェクション対策、レスポンス生成での XSS 対策を各レイヤーで実装し、多層防御による堅牢なセキュリティアーキテクチャを構築する。認証・認可は個人環境前提により簡素化し、保守性を重視した設計とする。

## 結論

<!-- GLOBAL_CONCLUSION_BEGIN: security-design -->

- **認証・認可なし**: 個人環境前提により実装せず、シンプルな構成を維持する。
- **セキュリティヘッダー設定**: CSP、X-Frame-Options、X-Content-Type-Options、X-XSS-Protection により基本的なブラウザレベル防御を確立する。
- **HSTS 設定除外**: 開発・テスト環境への支障を避けるため除外する。
- **多層防御実装**: リクエストレイヤーでの入力バリデーション、データアクセスレイヤーでの SQL インジェクション対策、レスポンスレイヤーでの XSS 対策を実装する。
- **個人用途最適化**: Rate Limiting は個人用途により不要とし、セキュリティログも別レイヤー処理として除外する。
- **法的要件遵守**: LLM API 利用規約遵守により、法的要件を満たしたセキュリティ体制を実現する。

<!-- GLOBAL_CONCLUSION_END: security-design -->

### 論理的根拠

認証・認可なしにより、攻撃対象面が作成者個人環境に限定されるため、高度な認証機能や複雑なアクセス制御は不要であり、一人で管理可能な複雑度を維持する。

セキュリティヘッダー設定により、ブラウザレベルでの攻撃防御を自動化し、開発・保守負荷を抑制しながら堅牢性を向上させる。

HSTS 設定除外により、実用性と安全性のバランスを確保し、開発・テスト環境での支障を回避する。

多層防御実装により、各レイヤーで適切なセキュリティ対策を実装し、多層防御による堅牢なセキュリティアーキテクチャを構築する。

個人用途最適化により、個人環境における適切な防御レベルを確立し、開発者としての責任とプロフェッショナルな品質確保を実現する。

法的要件遵守により、個人情報保護法と LLM API 利用規約等の法的要件を満たし、適切なセキュリティ体制を実現する。
