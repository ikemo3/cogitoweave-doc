---
doc_type: "pattern-logic"
status: "draft"
depends:
  contracts:
    - "traceability-strategy"
    - "backend-performance-design"
    - "development-constraints"
  produces:
    - "monitoring-design"
---

# 監視設計

CogitoWeave システムにおけるサービス内監視とメトリクス設計を行う。個人用途に適したシンプルで実用的な監視戦略を確立する。

## 前提

<!-- PREMISE_BEGIN: traceability-strategy -->

- **エラートラッキングとシステム監視を分離**: エラー情報の詳細追跡とシステム全体の稼働監視を分離し、既存インフラとの統合を優先する。
- **フロントエンド起点の一括トレーシング**: CSR アーキテクチャを活用したクライアントサイド監視と 3 つのバックエンドサービスとの統合により、システム全体の動作を把握する。
- **必要最小限の監視項目**: 障害検知・エラー把握・パフォーマンス監視に絞り込み、複雑なメトリクスや分析機能は除外する。

<!-- PREMISE_END: traceability-strategy -->

<!-- PREMISE_BEGIN: backend-performance-design -->

- **応答時間制約**: API 呼び出し 600ms 以内という制約を満たすため、N+1 問題の対策とクエリの最適化を実装する。
- **最小限の最適化**: 複雑なキャッシュ層や分散処理は除外し、必要に応じたデータベースインデックスの設定による最小限の最適化を行う。
- **単一サーバー構成**: 数万件規模のデータに対応することにより、個人用途に十分な性能を確保する。
- **垂直スケーリング**: 性能が劣化した場合はサーバースペックの向上による垂直スケーリングで対応する。
- **シンプルな構成維持**: 複雑な最適化機構は保守性制約により実装せず、理解しやすい構成で長期安定運用を実現する。

<!-- PREMISE_END: backend-performance-design -->

<!-- PREMISE_BEGIN: development-constraints -->

- シンプルで理解しやすい構造、一人で管理可能な複雑度に制限する。

<!-- PREMISE_END: development-constraints -->

## 論理

### 問題設定

CogitoWeave システムの 3 つのサービス（コア知識管理、LLM 統合、コンテンツ取得）それぞれで必要な監視項目とメトリクス設計を行う必要がある。個人用途の制約下で、障害の早期発見と性能問題の特定を実現する監視戦略を論理的に導出する。

### 分析

#### サービス別監視要件の分析

各サービスの特性に応じた監視項目を分析し、適切なメトリクス設計を決定する。

**コア知識管理サービス**: システムの中核機能を担当し、概念・文献メモ・関係性データの永続化を行う。データの整合性維持と安定した応答時間が最重要である。CRUD 操作の応答時間監視、データベース接続状況監視、データ整合性チェックが必要である。

**LLM 統合サービス**: 外部 API に依存した処理が中心であり、外部依存による障害の影響を最も受けやすい。外部 API の応答時間と成功率の監視、API 使用量の追跡、エラー種別の分類が重要である。タイムアウトや API 制限への対応状況を可視化する必要がある。

**コンテンツ取得サービス**: Web スクレイピングを行うため、外部サイトの変更による影響を受けやすい。取得成功率の監視、処理時間の変動監視、サイト構造変更の早期検知が必要である。短期リリースサイクルに対応するため、デプロイ後の動作監視も重要である。

#### 監視項目の階層設計

個人用途に適した監視項目を階層的に設計し、重要度に応じた監視レベルを確立する。

**必須監視項目**: システムの基本動作を保証する最小限の項目として、各サービスの生存確認、データベース接続状況、外部 API 接続状況を監視する。これらは障害の即座発見に直結し、復旧対応の判断材料となる。

**性能監視項目**: 設定した応答時間制約の遵守状況を監視する項目として、API 応答時間、データベースクエリ実行時間、外部依存処理時間を追跡する。性能劣化の早期発見により、垂直スケーリングの判断を支援する。

**運用監視項目**: 一人運用での判断を支援する情報として、リクエスト数の推移、エラー発生パターン、リソース使用状況を記録する。複雑な分析は不要だが、運用傾向の把握により予防的な対応を可能にする。

#### アラート設計の論理

一人運用に適したアラート戦略を設計し、過剰な通知による疲労を回避する。

**緊急度分類**: 即座対応が必要な障害、計画的対応で十分な問題、情報として記録するだけの事象に分類する。緊急度に応じた通知方法を設定し、重要な問題に集中できる環境を構築する。

**アラート抑制**: 同一原因による大量通知を防ぐため、関連するアラートをグループ化し、根本原因の特定を支援する構造を設計する。外部依存の障害時は、影響を受ける複数の監視項目が同時にアラートを発するため、統合的な通知が必要である。

## 結論

<!-- GLOBAL_CONCLUSION_BEGIN: monitoring-design -->

- **サービス特性別監視**: コア知識管理サービスはデータ整合性と応答時間を重視し、LLM 統合サービスは外部 API 依存性を監視し、コンテンツ取得サービスは取得成功率と構造変更を追跡する。
- **階層的監視項目**: 必須監視項目で基本動作を保証し、性能監視項目で応答時間制約を管理し、運用監視項目で長期的な運用判断を支援する。
- **緊急度分類アラート**: 緊急度分類による適切な通知とアラート抑制による根本原因の明確化により、一人での迅速な障害対応を可能にする。

<!-- GLOBAL_CONCLUSION_END: monitoring-design -->

### 論理的根拠

サービス特性別監視により、各サービスの責務に応じた監視で効率的な障害特定と対応を支援し、コア知識管理サービスのデータ整合性維持、LLM 統合サービスの外部依存障害対応、コンテンツ取得サービスの短期リリースサイクル対応を実現する。

階層的監視項目により、管理負荷と監視効果のバランスを達成し、重要度に応じた監視レベルで一人運用での効率的な監視を実現し、必要最小限の監視項目による複雑性回避を図る。

緊急度分類アラートにより、過剰通知を回避し重要問題への集中を支援し、外部依存の障害時に影響を受ける複数の監視項目が同時にアラートを発する際の統合的な通知により、一人運用に適したアラート戦略を実現する。
