---
doc_type: "pattern-logic"
status: "draft"
depends:
  contracts:
    - "monitoring-design"
    - "database-approach"
    - "development-constraints"
    - "testing-automation-requirements"
  produces:
    - "backend-test-strategy"
    - "frontend-test-strategy"
    - "api-contract-test-strategy"
---

# サービス内テスト戦略

CogitoWeave システムにおけるバックエンド内統合テスト・ユニットテストとフロントエンド内統合テスト・コンポーネントテスト・ユニットテストの戦略を策定する。個人開発に適したシンプルで確実なテスト体制を確立する。

## 前提

<!-- PREMISE_BEGIN: monitoring-design -->

- **サービス特性別監視**: コア知識管理サービスはデータ整合性と応答時間を重視し、LLM 統合サービスは外部 API 依存性を監視し、コンテンツ取得サービスは取得成功率と構造変更を追跡する。
- **階層的監視項目**: 必須監視項目で基本動作を保証し、性能監視項目で応答時間制約を管理し、運用監視項目で長期的な運用判断を支援する。
- **緊急度分類アラート**: 緊急度分類による適切な通知とアラート抑制による根本原因の明確化により、一人での迅速な障害対応を可能にする。

<!-- PREMISE_END: monitoring-design -->

<!-- PREMISE_BEGIN: database-approach -->

CogitoWeave では RDBMS を採用する。リレーショナル構造によるデータ整合性管理、成熟技術による保守性確保、データ規模への十分な対応能力が主な選択理由である。具体的な製品選択は Development View で決定する。

<!-- PREMISE_END: database-approach -->

<!-- PREMISE_BEGIN: development-constraints -->

- シンプルで理解しやすい構造、一人で管理可能な複雑度に制限する。

<!-- PREMISE_END: development-constraints -->

<!-- PREMISE_BEGIN: testing-automation-requirements -->

- **バックエンドは完全に自動テスト**: ほぼ 100%のテストで品質を担保する
- **フロントエンドは状況に応じて使い分け**: ブラウザでの複雑な操作やデザインの確認は手動テスト、ロジック部分は自動テストを行う
- **障害対応をスクリプト化**: 復旧作業を自動化して保守の負担を減らす
- **データ移行を自動化**: データベース構造を変更するときは自動で処理する

<!-- PREMISE_END: testing-automation-requirements -->

## 論理

### 問題設定

バックエンドの 3 つのサービス（コア知識管理、LLM 統合、コンテンツ取得）それぞれの特性に応じたテスト戦略と、フロントエンドのユニットテスト・コンポーネントテスト・統合テスト戦略を策定する必要がある。個人開発の制約下で、外部依存を含むシステムの品質保証を効率的に実現するテスト体制を論理的に導出する。

### バックエンドテスト戦略

#### バックエンドサービス別テスト要件

各バックエンドサービスの特性に応じたテスト要件を分析し、適切なテスト戦略を決定する。

**コア知識管理サービス**は CRUD 操作とデータ整合性が中核であり、データベース操作の正確性と境界条件での動作が最重要である。ユニットテストでビジネスロジックを検証し、統合テストでデータベース操作とトランザクション境界を確認する必要がある。外部依存が最小のため、テスト環境の構築が最も単純である。

**LLM 統合サービス**は外部 API への依存度が高く、API 仕様の変更や応答時間の変動による影響を受けやすい。外部 API の契約レベルでの検証と、異常ケース（タイムアウト、エラーレスポンス）への対応が必要である。モック化による安定したテスト実行と、契約テストによる仕様変更の早期検知が重要である。

**コンテンツ取得サービス**は Web スクレイピングによりサイト構造の変更に影響されやすく、取得成功率の維持が課題である。HTML 構造の変動に対する適応性と、ネットワーク障害への対応を検証する必要がある。短期リリースサイクルに対応するため、迅速なテスト実行とデプロイメント後の動作確認が重要である。

#### テスト要件から環境要求への導出

上記のテスト要件を満たすために必要な環境要件を論理的に導出する。

**データベース操作検証要件**: コア知識管理サービスのデータベース操作とトランザクション境界を確認するためには、高速に繰り返し実行でき、テスト間でクリーンな状態を保証できるデータベース環境が必要である。本番環境との完全一致よりも、テスト実行速度と管理負荷の軽減を優先する環境が求められる。

**外部 API 依存の安定化要件**: LLM 統合サービスとコンテンツ取得サービスの外部 API 依存により、CI 環境での実際の API 呼び出しは不安定要因となる。API 仕様変更の早期検知と異常ケース対応の検証を実現しつつ、安定したテスト実行を保証する環境が必要である。

**個人開発制約への適応要件**: 一人開発においては、複雑な環境構築や保守負荷は現実的でない。設定の理解しやすさと環境管理の簡便性を重視し、継続的な品質検証の確実性を保証する軽量な環境が求められる。

#### バックエンドテスト環境

上記の環境要件を満たす具体的なテスト環境を設計する。

**SQLite インメモリデータベース**: データベース操作検証要件に対応し、高速なテスト実行とテスト毎のクリーンな状態確保を実現する。データベース操作とトランザクション境界の検証において、本番環境との整合性よりも実行速度と管理負荷の軽減を優先する。

**外部 API モック化**: 外部 API 依存の安定化要件に対応し、HTTP 通信レベルで LLM API 呼び出しと Web スクレイピングをモック化してテスト実行の安定性を確保する。契約テストによる仕様変更の早期検知と、異常ケーステストによる障害耐性の検証を実現する。

**軽量な環境構築**: 個人開発制約への適応要件に対応し、複雑な設定や専用インフラを回避した軽量な環境を構築する。設定ファイルベースの簡潔な管理により、継続的な品質検証の確実性を保証する。

### フロントエンドテスト戦略

#### フロントエンドテスト要件

フロントエンドのユニットテスト、コンポーネントテスト、統合テストの要件を分析し、適切なテスト戦略を決定する。

**フロントエンドユニットテスト**では、個別のユーティリティ関数やビジネスロジック関数の正確性を検証する必要がある。データ変換、バリデーション、計算処理等の純粋関数については自動テストで確実に品質を保証し、UI に依存しない部分の動作を検証する。

**フロントエンドコンポーネントテスト**では、個別のコンポーネントの動作と表示の正確性を検証する必要がある。コンポーネントのプロパティによる表示変化、イベントハンドリング、内部状態の管理を自動テストで確認し、コンポーネント単位での品質を保証する。

**フロントエンド統合テスト**では、複数のコンポーネントが連携した際の状態管理と画面遷移の正確性を検証する必要がある。ルーティング、状態の受け渡し、イベント処理の統合動作を自動テストで確認し、デザインや複雑な操作は手動テストで補完する。

#### フロントエンドテスト環境

フロントエンド専用のテスト環境を各テストレイヤーに適した形で構築する。

**ユニットテスト環境**: ユーティリティ関数やビジネスロジック関数のための軽量な実行環境を提供する。DOM や外部依存を排除し、純粋関数の動作を高速に検証する。

**コンポーネントテスト環境**: 個別コンポーネントの表示とイベントハンドリングを検証するための DOM 環境を提供する。コンポーネントの分離テストと内部状態管理の検証を可能にする。

**統合テスト環境**: 複数コンポーネント間の連携を検証するためのルーティング・状態管理環境を提供する。バックエンド API への依存はモック化することで安定したテスト実行を確保する。

### API 契約テスト戦略

#### フロントエンド・バックエンド間 API 契約

サービス間のインターフェース契約を明確に定義し、契約レベルでの検証を実現する。

**API 契約の明文化**: フロントエンド・バックエンド間のリクエスト・レスポンス仕様を明確に定義し、インターフェース契約として文書化する。API 仕様の変更や破壊的変更を早期に検知するための基盤を構築する。

**契約テストの実装**: バックエンド側では API 仕様への準拠を検証し、フロントエンド側では TypeScript 型定義による契約検証とモックの型安全性確保を行う。完全なエンドツーエンドテストよりも、変更の影響範囲を限定した効率的な検証を実現する。

## 結論

### バックエンドテスト戦略決定

<!-- GLOBAL_CONCLUSION_BEGIN: backend-test-strategy -->

- **サービス特性別テスト**: コア知識管理サービスはデータベース操作とトランザクション境界を検証し、LLM 統合サービスは外部 API の契約テストと異常ケース（タイムアウト、エラーレスポンス）対応を実装し、コンテンツ取得サービスは構造変更への適応性を検証する。
- **バックエンドテスト環境**: インメモリ SQLite を使用した高速なテスト実行とテスト毎のクリーンな状態確保、HTTP 通信レベルでの外部 API モック化による安定したテスト実行を実現する。

<!-- GLOBAL_CONCLUSION_END: backend-test-strategy -->

### フロントエンドテスト戦略決定

<!-- GLOBAL_CONCLUSION_BEGIN: frontend-test-strategy -->

- **フロントエンドユニットテスト**: ユーティリティ関数やビジネスロジック関数の正確性を検証し、データ変換・バリデーション・計算処理等の純粋関数の動作を検証する。
- **フロントエンドコンポーネントテスト**: 個別のコンポーネントの動作と表示の正確性を検証し、プロパティによる表示変化・イベントハンドリング・内部状態管理を検証する。
- **フロントエンド統合テスト**: 複数のコンポーネント間の連携を検証し、状態管理・画面遷移・ルーティング・イベント処理の統合動作を検証する。
- **フロントエンドテスト環境**: ユニットテスト用の軽量実行環境・コンポーネントテスト用の DOM 環境・統合テスト用のルーティング状態管理環境を提供し、バックエンド API 依存をモック化する。

<!-- GLOBAL_CONCLUSION_END: frontend-test-strategy -->

### API 契約テスト戦略決定

<!-- GLOBAL_CONCLUSION_BEGIN: api-contract-test-strategy -->

- **フロントエンド・バックエンド間 API 契約**: リクエスト・レスポンス仕様を明文化し、インターフェース契約として文書化する。バックエンド側での API 仕様準拠検証とフロントエンド側での TypeScript 型定義による契約検証により、API 仕様変更の早期検知を実現する。

<!-- GLOBAL_CONCLUSION_END: api-contract-test-strategy -->

### 論理的根拠

**バックエンドテスト戦略の論理**: サービス特性別テストにより、各サービスの責務に応じたテスト戦略で効率的な品質保証を実現し、CRUD 操作とデータ整合性、外部 API 依存、Web スクレイピングの各特性に最適化されたテスト体制を構築する。軽量テスト環境により、個人開発に適した継続的テストを実現し、本番環境との完全一致よりも実行速度と管理負荷の軽減を優先する。

**フロントエンドテスト戦略の論理**: 各テストレイヤーに専用環境を提供することで、ユニットテスト・コンポーネントテスト・統合テストそれぞれの特性に最適化された検証を実現する。UI 依存部分と純粋関数部分を適切に分離し、自動テストと手動テストの使い分けにより効率的な品質保証を実現する。

**API 契約テスト戦略の論理**: フロントエンド・バックエンド間のインターフェース契約を明文化することで、サービス間の依存関係を最小化し、変更の影響範囲を限定した効率的な検証を実現する。TypeScript 型定義による契約検証により、API 仕様変更の早期検知と型安全性を両立する。
